

// Name: BeyondTrust Bomgar Post-Exploitation Activity (CVE-2026-1731)
// Description: Detect suspicious post-exploitation commands executed via BeyondTrust/Bomgar session process bomgar-scc.exe.
// Reference: https://unit42.paloaltonetworks.com/beyondtrust-cve-2026-1731/

let Lookback = 24h;
let Parent = dynamic(["bomgar-scc.exe","bomgar-scc"]);
// High-signal child executables (Windows-focused; aligns with Unit42 Bomgar post-exploitation patterns) [1](https://app.any.run/tasks/85859492-c823-404c-b194-d72b0180bcd8)
let SuspiciousChildExe = dynamic([
  "cmd.exe","powershell.exe","pwsh.exe","mshta.exe","rundll32.exe","regsvr32.exe",
  "certutil.exe","bitsadmin.exe","wevtutil.exe","vssadmin.exe","ntdsutil.exe",
  "nltest.exe","dsquery.exe","quser.exe","qwinsta.exe","tasklist.exe","net.exe","net1.exe",
  "whoami.exe","hostname.exe","ipconfig.exe","arp.exe","netstat.exe","klist.exe",
  "curl.exe","wget.exe","python.exe","python3.exe"
]);
// Command-line substrings that indicate post-exploitation intent
let SuspiciousCmdSubstrings = dynamic([
  // Privilege / account ops
  "domain admins","enterprise admins","localgroup administrators"," net user "," /add"," add-localgroupmember"," new-localuser",
  // Credential access / dumping / shadow copies
  "ntds.dit","lsass","comsvcs.dll","sekurlsa","dcsync","vssadmin delete shadows","ntdsutil",
  // Recon & lateral movement
  "nltest","dsquery","net group","net view","whoami /all","quser","qwinsta","tasklist","netstat -ano",
  // Defense evasion / log clearing
  "wevtutil cl","clear-eventlog","del /f /q", "reg delete",
  // Download/execute cradles
  "iwr ","invoke-webrequest","downloadstring","bitsadmin /transfer","certutil -urlcache","curl ","wget "
]);
DeviceProcessEvents
| where TimeGenerated > ago(Lookback)
| where InitiatingProcessFileName in~ (Parent)
| extend cmd = tolower(ProcessCommandLine)
| extend child = tolower(FileName)
// Filter: either suspicious child exe OR suspicious command-line patterns
| where child in~ (SuspiciousChildExe) or cmd has_any (SuspiciousCmdSubstrings)
// Risk scoring (raise signal when multiple high-risk behaviors appear) [1](https://app.any.run/tasks/85859492-c823-404c-b194-d72b0180bcd8)
| extend RiskScore =
    case(
      cmd has "domain admins" or cmd has "enterprise admins", 5,
      cmd has "ntds.dit" or cmd has "dcsync" or cmd has "sekurlsa" or child in~ ("ntdsutil.exe","vssadmin.exe"), 5,
      cmd has_any ("wevtutil cl","clear-eventlog"), 4,
      child in~ ("mshta.exe","rundll32.exe","regsvr32.exe"), 3,
      cmd has_any ("downloadstring","bitsadmin /transfer","certutil -urlcache","invoke-webrequest","curl ","wget "), 3,
      child in~ ("nltest.exe","dsquery.exe","quser.exe","qwinsta.exe","net.exe","net1.exe"), 2,
      1
    )
// Summarize by device + account + bomgar session commandline to avoid hour-splitting
| summarize
    StartTime = min(TimeGenerated),
    EndTime   = max(TimeGenerated),
    TotalRiskScore = sum(RiskScore),
    UniqueChildCount = dcount(FileName),
    ChildProcesses = make_set(FileName, 25),
    SuspiciousCmds  = make_set(ProcessCommandLine, 25),
    BomgarCmdLine = take_any(InitiatingProcessCommandLine)
  by DeviceName, AccountName, InitiatingProcessFileName
// Threshold: tune to your environment
| where TotalRiskScore >= 8 and UniqueChildCount >= 2
| project StartTime, EndTime, DeviceName, AccountName, InitiatingProcessFileName, BomgarCmdLine,
          TotalRiskScore, UniqueChildCount, ChildProcesses, SuspiciousCmds
| extend timestamp = StartTime, HostCustomEntity = DeviceName, AccountCustomEntity = AccountName