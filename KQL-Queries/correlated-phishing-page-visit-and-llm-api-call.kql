// Name: Correlated Phishing Page Visit and LLM API Call
// Author: Rudra Verma - CyberHawk
// Date: 2026-02-08
// Description: Detects a browser visiting a URL with phishing-related keywords, followed by a direct network connection to a known Large Language Model (LLM) API endpoint from the same device within a short time window. This correlated behavior is a strong indicator of the "runtime assembly" attack pattern, where a malicious page dynamically generates a phishing payload by calling an LLM service.
// False Positive Sensitivity: Medium
// References:
// - https://unit42.paloaltonetworks.com/real-time-malicious-javascript-through-llms/
// Name: LLM-Augmented Phishing Detection - Correlated Suspicious Page + API Calls
// Author: Rudra Verma - CyberHawk
// Date: 2026-02-09
// References: https://unit42.paloaltonetworks.com/real-time-malicious-javascript-through-llms/

let timeframe = 1d;
let correlationWindow = 5m;
let browserProcesses = dynamic([
    "chrome.exe", "msedge.exe", "firefox.exe", "brave.exe", "iexplore.exe"
]);
let phishingUrlKeywords = dynamic([
    "login", "signin", "logon", "verify", "account", 
    "password", "credential", "support", "authenticate"
]);
let legitimateDomains = dynamic([
    "microsoft.com", "office.com", "live.com", "google.com",
    "accounts.google.com", "facebook.com", "apple.com", 
    "amazon.com", "okta.com", "service-now.com"
]);
let llmApiDomains = dynamic([
    "api.openai.com", "generativelanguage.googleapis.com",
    "api.deepseek.com", "api.anthropic.com", "api.mistral.ai"
]);
let SuspiciousPageVisits = 
    DeviceNetworkEvents
    | where TimeGenerated > ago(timeframe)
    | where InitiatingProcessFileName in~ (browserProcesses)
    | where isnotempty(RemoteUrl)
    | extend Domain = tostring(parse_url(RemoteUrl).Host)
    | extend Path = tostring(parse_url(RemoteUrl).Path)
    | where isnotempty(Path)
    | where Path has_any (phishingUrlKeywords)
    | where not(Domain has_any (legitimateDomains))
    | project 
        PhishingVisitTime = TimeGenerated, 
        DeviceId, 
        PhishingAccountName = InitiatingProcessAccountName,
        PhishingUrl = RemoteUrl,
        PhishingDomain = Domain,
        PhishingRemoteIP = RemoteIP,
        PhishingProcessName = InitiatingProcessFileName;
let LLM_API_Calls = 
    DeviceNetworkEvents
    | where TimeGenerated > ago(timeframe)
    | where InitiatingProcessFileName in~ (browserProcesses)
    | where RemoteUrl has_any (llmApiDomains)
    | project 
        LLMCallTime = TimeGenerated, 
        DeviceId, 
        LLMAccountName = InitiatingProcessAccountName,
        LLMApiUrl = RemoteUrl,
        LLMRemoteIP = RemoteIP,
        LLMProcessCommandLine = InitiatingProcessCommandLine;
SuspiciousPageVisits
| join kind=inner hint.strategy=shuffle (
    LLM_API_Calls
) on DeviceId
| where PhishingAccountName == LLMAccountName 
    or isempty(PhishingAccountName) 
    or isempty(LLMAccountName)
| where LLMCallTime between (PhishingVisitTime .. (PhishingVisitTime + correlationWindow))
| extend TimeDelta = LLMCallTime - PhishingVisitTime
| summarize 
    FirstPhishingVisit = min(PhishingVisitTime),
    LastLLMCall = max(LLMCallTime),
    EventCount = count(),
    PhishingUrls = make_set(PhishingUrl, 10),
    PhishingDomains = make_set(PhishingDomain, 10),
    PhishingIPs = make_set(PhishingRemoteIP, 10),
    LLMApiUrls = make_set(LLMApiUrl, 10),
    LLMIPs = make_set(LLMRemoteIP, 10),
    CommandLines = make_set(LLMProcessCommandLine, 5)
    by DeviceId, PhishingAccountName, PhishingProcessName, bin(PhishingVisitTime, 1h)
| where EventCount >= 2
| extend AlertSeverity = case(
    EventCount >= 5, "High",
    EventCount >= 3, "Medium",
    "Low"
)
| project-reorder
    AlertSeverity,
    FirstPhishingVisit,
    LastLLMCall,
    EventCount,
    DeviceId,
    PhishingAccountName,
    PhishingProcessName,
    PhishingUrls,
    PhishingDomains,
    PhishingIPs,
    LLMApiUrls,
    LLMIPs,
    CommandLines
| sort by AlertSeverity desc, EventCount desc

