// Name: WSUS Service Exploitation - Suspicious Child Processes (CVE-2025-59287)
// Author: Rudra Verma - CyberHawk
// Date: 2026-02-10
// MITRE ATT&CK: T1190 (Exploit Public-Facing Application)
// CVE: CVE-2025-59287
// Reference: https://www.fortra.com/blog/velociraptor-dfir-tool-abused-wsus-rce-cve-2025-59287

DeviceProcessEvents
| where TimeGenerated > ago(30d)
| where InitiatingProcessFileName =~ "WsusService.exe"
| where FileName in~ ("cmd.exe", "powershell.exe", "curl.exe", "wget.exe", "certutil.exe", "bitsadmin.exe", "msiexec.exe")
| extend Severity = case(
    FileName in~ ("curl.exe", "certutil.exe", "bitsadmin.exe"), "Critical",
    FileName in~ ("powershell.exe", "cmd.exe"), "High",
    "Medium"
)
| extend ThreatDetails = strcat(
    " WSUS Service spawned ", FileName, 
    " | CmdLine: ", substring(ProcessCommandLine, 0, 200),
    " | User: ", AccountName
)
| summarize 
    FirstSeen = min(TimeGenerated),
    LastSeen = max(TimeGenerated),
    ExecutionCount = count(),
    ProcessesSpawned = make_set(FileName),
    CommandLines = make_set(substring(ProcessCommandLine, 0, 200), 10)
    by DeviceName, AccountName
| extend 
    DaysActive = datetime_diff('day', LastSeen, FirstSeen),
    RequiresIsolation = "YES - WSUS RCE Exploitation",
    InvestigationSteps = "1) ISOLATE device immediately - active RCE exploitation. 2) Check for Velociraptor installation in 'C:\\Program Files\\Velociraptor'. 3) Review CommandLines for download URLs (Cloudflare Workers domains). 4) Hunt for VS Code tunnel installations in C:\\ProgramData. 5) Collect memory dump and full forensic triage."
| project 
    RequiresIsolation,
    Severity = "Critical",
    InvestigationSteps,
    FirstSeen,
    LastSeen,
    DaysActive,
    DeviceName,
    AccountName,
    ExecutionCount,
    ProcessesSpawned,
    CommandLines
| sort by FirstSeen desc
